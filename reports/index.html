<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>Lighthouse Result</title>
  <!-- https://datatables.net/manual/ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.semanticui.min.css" />
  <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
  <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.19/js/dataTables.semanticui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.js"></script>
  <!-- https://datatables.net/extensions/fixedheader/ -->
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.1.5/css/fixedHeader.semanticui.min.css">
  <script src="https://cdn.datatables.net/fixedheader/3.1.5/js/fixedHeader.semanticui.min.js"></script>
  <!-- https://c3js.org/examples.html -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.7/c3.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.7/c3.min.js"></script>
  <style>
    .chart {
      float: left;
      width: 100%;
      height: 300px;
      font-weight: bold;
      border: solid 1px gray;
      margin: auto;
    }

    .c3-title {
      font-weight: bold;
    }

    .c3-region.regionY-green {
      fill: #00E673;
      /* #3D7F41 */
    }

    .c3-region.regionY-yellow {
      fill: #FFFF00;
      /* #D87C2E */
    }

    .c3-region.regionY-red {
      fill: #E60000;
      /* #B8342A */
    }
  </style>
</head>

<body>
  <table id="latestTable" class="ui celled table" style="width:100%">
    <thead>
      <tr>
        <th>Name</th>
        <th>URL</th>
        <th>Performance</th>
        <th>PWA</th>
        <th>Accessibility</th>
        <th>Best Practices</th>
        <th>SEO</th>
        <th>Latest FetchTime</th>
      </tr>
    </thead>
  </table>
  <div id="graphArea">
    <h2 id="graphTitle">Graph</h2>
    <div id="performance" class="chart"></div>
    <div id="pwa" class="chart"></div>
    <div id="accessibility" class="chart"></div>
    <div id="best-practices" class="chart"></div>
    <div id="seo" class="chart"></div>
    <div id="first-contentful-paint" class="chart"></div>
    <div id="first-meaningful-paint" class="chart"></div>
    <div id="speed-index" class="chart"></div>
    <div id="first-cpu-idle" class="chart"></div>
    <div id="time-to-interactive" class="chart"></div>
    <div id="estimated-input-latency" class="chart"></div>
    <div id="time-to-first-byte" class="chart"></div>
  </div>
  <script>
    function chartFromJson(jsonData, dirUrl, keyId, titleText, axisY, regions) {
      var keyArray = [];
      keyArray.push(keyId);
      var regionArray = [];
      if (regions !== undefined && regions.length > 0) {
        regionArray = regionArray.concat(regions);
      }
      return c3.generate({
        title: {
          show: true,
          text: titleText,
          position: 'top-center',
          padding: {
            top: 20,
            right: 20,
            bottom: 40,
            left: 50
          }
        },
        legend: {
          show: false,
          // position: 'inset',
          // inset: {
          //   anchor: 'top-left', // top-left, top-center and top-right
          //   x: 20,
          //   y: 0,
          //   step: 1
          // },
        },
        bindto: '#' + keyId,
        data: {
          json: jsonData,
          mimeType: 'json',
          keys: {
            x: 'datetime',
            value: keyArray,
          },
          type: 'spline',
          onclick: function (d, element) {
            var relativeUrl = dirUrl + '/' + jsonData[d.index]['datetime'] + '_lighthouse.report.html';
            window.open(relativeUrl, '_blank', 'width=800,height=600');
          }
        },
        axis: {
          x: {
            type: 'category',
            multiline: true,
            height: 77,
            padding: {
              left: 0,
              right: 0
            }
          },
          y: Object.assign({
            padding: { top: 0, bottom: 0 }
          }, axisY)
        },
        regions: regionArray
      });
    }

    function onSelectTarget(name, jsonUrl) {
      $('#graphArea').show();
      $('#graphTitle').text(name);
      $('title').html(name + ' - Lighthouse Result');
      var dirUrl = jsonUrl.replace('/summary.json', '');
      $.getJSON(jsonUrl,
        function (jsonData) {
          console.log(jsonData);
          // Score
          var regions4Score = [
            { axis: 'y', start: 90, end: 100, class: 'regionY-green' },
            { axis: 'y', start: 50, end: 89, class: 'regionY-yellow' },
            { axis: 'y', start: 0, end: 49, class: 'regionY-red' },
          ];
          var axisY4Score = { max: 100, min: 0 };
          chartFromJson(jsonData, dirUrl, 'performance', 'Performance (score)', axisY4Score, regions4Score);
          chartFromJson(jsonData, dirUrl, 'pwa', 'Progressive Web App (score)', axisY4Score, regions4Score);
          chartFromJson(jsonData, dirUrl, 'accessibility', 'Accessibility (score)', axisY4Score, regions4Score);
          chartFromJson(jsonData, dirUrl, 'best-practices', 'Best Practices (score)', axisY4Score, regions4Score);
          chartFromJson(jsonData, dirUrl, 'seo', 'SEO (score)', axisY4Score, regions4Score);
          // Detail (TODO: Tuning threshold.)
          var axisY4Detail = { min: 0 };
          // FCP
          chartFromJson(jsonData, dirUrl, 'first-contentful-paint', 'First Contentful Paint (ms)', axisY4Detail, [
            { axis: 'y', start: 4500, class: 'regionY-red' },
            { axis: 'y', start: 2500, end: 4499, class: 'regionY-yellow' },
            { axis: 'y', start: 0, end: 2499, class: 'regionY-green' },
          ]);
          // FMP
          chartFromJson(jsonData, dirUrl, 'first-meaningful-paint', 'First Meaningful Paint (ms)', axisY4Detail, [
            { axis: 'y', start: 4350, class: 'regionY-red' },
            { axis: 'y', start: 2350, end: 4349, class: 'regionY-yellow' },
            { axis: 'y', start: 0, end: 2349, class: 'regionY-green' },
          ]);
          // SPDIDX
          chartFromJson(jsonData, dirUrl, 'speed-index', 'Speed Index (ms)', axisY4Detail, [
            { axis: 'y', start: 6050, class: 'regionY-red' },
            { axis: 'y', start: 3350, end: 6049, class: 'regionY-yellow' },
            { axis: 'y', start: 0, end: 3349, class: 'regionY-green' },
          ]);
          // FCI
          chartFromJson(jsonData, dirUrl, 'first-cpu-idle', 'First CPU Idle (ms)', axisY4Detail, [
            { axis: 'y', start: 6550, class: 'regionY-red' },
            { axis: 'y', start: 2350, end: 6549, class: 'regionY-yellow' },
            { axis: 'y', start: 0, end: 2349, class: 'regionY-green' },
          ]);
          // TTI
          chartFromJson(jsonData, dirUrl, 'time-to-interactive', 'Time to Interactive (ms)', axisY4Detail, [
            { axis: 'y', start: 6550, class: 'regionY-red' },
            { axis: 'y', start: 2350, end: 6549, class: 'regionY-yellow' },
            { axis: 'y', start: 0, end: 2349, class: 'regionY-green' },
          ]);
          // EIL
          chartFromJson(jsonData, dirUrl, 'estimated-input-latency', 'Estimated Input Latency (ms)', axisY4Detail, [
            { axis: 'y', start: 105, class: 'regionY-red' },
            { axis: 'y', start: 50, end: 104, class: 'regionY-yellow' },
            { axis: 'y', start: 0, end: 49, class: 'regionY-green' },
          ]);
          // TTFB
          chartFromJson(jsonData, dirUrl, 'time-to-first-byte', 'Time To First Byte (ms)', axisY4Detail, [
            { axis: 'y', start: 600, class: 'regionY-red' },
            { axis: 'y', start: 0, end: 599, class: 'regionY-green' },
          ]);
        }
      );
    }

    $(function () {
      $.extend($.fn.dataTable.defaults, {
        // language: { url: "http://cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Japanese.json" }
      });
      var latestTable = $('#latestTable').DataTable({
        fixedHeader: true,
        ajax: { url: "./latest.json", dataSrc: '' },
        columns: [
          {
            data: 'name',
            render: function (data, type, row, meta) {
              if (type === 'display') {
                data = '<a href="javascript:void(0);" onclick="onSelectTarget(\'' + data + '\',\'' + row.path + '\');">' + data + '</a>'
              }
              return data;
            }
          },
          {
            data: 'url',
            render: function (data, type, row, meta) {
              if (type === 'display') {
                data = '<a href="' + row.url + '">' + data + '</a>';
              }
              return data;
            }
          },
          { data: 'performance' },
          { data: 'pwa' },
          { data: 'accessibility' },
          { data: 'best-practices' },
          { data: 'seo' },
          { data: 'datetime' }
        ]
      });
      $('#graphArea').hide();
    });
  </script>

</body>

</html>
